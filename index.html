<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¢×§×‘ ×©×™×¢×•×¨×™ ×‘×™×ª</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { min-height: 100vh; background: #0a0a0f; font-family: 'Courier New', monospace; background-image: radial-gradient(ellipse at 20% 50%, #0d1a2a 0%, transparent 60%), radial-gradient(ellipse at 80% 20%, #1a0d1a 0%, transparent 60%); color: #fff; direction: rtl; }

    /* HEADER */
    header { border-bottom: 1px solid #222; padding: 20px 28px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); position: sticky; top: 0; z-index: 100; }
    .header-title-label { font-size: 11px; letter-spacing: 2px; color: #555; margin-bottom: 4px; }
    .header-title { font-size: 24px; font-weight: bold; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .user-badge { font-size: 12px; color: #888; padding: 6px 12px; border: 1px solid #222; border-radius: 8px; }

    /* BUTTONS */
    .btn { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-family: 'Courier New', monospace; transition: all 0.2s; border: none; }
    .btn-white { background: #fff; color: #000; font-weight: bold; }
    .btn-ghost { background: transparent; border: 1px solid #333; color: #888; }
    .btn-ghost:hover { border-color: #fff; color: #fff; }
    .btn-danger { background: transparent; border: 1px solid #ff2d55; color: #ff2d55; }
    .btn-blue { background: #64d2ff; color: #000; font-weight: bold; }
    .btn-full { width: 100%; padding: 14px; background: #fff; color: #000; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 14px; font-family: 'Courier New', monospace; margin-top: 8px; transition: background 0.2s; }
    .btn-full:hover { background: #e0e0e0; }

    /* MAIN */
    main { max-width: 700px; margin: 0 auto; padding: 40px 20px; }
    .add-btn-dashed { width: 100%; padding: 16px; background: transparent; border: 2px dashed #333; color: #666; border-radius: 16px; cursor: pointer; font-size: 15px; font-family: 'Courier New', monospace; transition: all 0.2s; margin-bottom: 28px; }
    .add-btn-dashed:hover { border-color: #fff; color: #fff; }

    /* FORMS */
    .add-form { background: #111; border: 1px solid #333; border-radius: 16px; padding: 24px; margin-bottom: 28px; display: flex; flex-direction: column; gap: 12px; }
    .form-title { font-weight: bold; letter-spacing: 1px; margin-bottom: 4px; font-size: 15px; }
    input[type=text], input[type=password], input[type=date], textarea {
      width: 100%; padding: 12px 14px; background: #0a0a0f; border: 1px solid #333;
      border-radius: 10px; color: #fff; font-size: 14px; font-family: 'Courier New', monospace;
      outline: none; text-align: right;
    }
    input[type=text]:focus, input[type=password]:focus, input[type=date]:focus, textarea:focus { border-color: #555; }
    input[type=date] { text-align: left; direction: ltr; }
    input[type=date]::-webkit-calendar-picker-indicator { filter: invert(1); }
    textarea { resize: none; height: 70px; }

    /* CHECKBOX */
    .checkbox-row { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: #0a0a0f; border: 1px solid #333; border-radius: 10px; cursor: pointer; user-select: none; transition: border-color 0.2s; }
    .checkbox-row:hover { border-color: #555; }
    .checkbox-row.active { border-color: #64d2ff; }
    .custom-checkbox { width: 20px; height: 20px; border-radius: 6px; border: 2px solid #444; background: transparent; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
    .custom-checkbox.checked { background: #64d2ff; border-color: #64d2ff; }
    .custom-checkbox.checked::after { content: 'âœ“'; font-size: 13px; color: #000; font-weight: bold; }
    .checkbox-label { color: #aaa; font-size: 13px; transition: color 0.2s; }
    .checkbox-row.active .checkbox-label { color: #fff; }
    .questions-box { overflow: hidden; max-height: 0; transition: max-height 0.3s ease, opacity 0.3s ease; opacity: 0; }
    .questions-box.open { max-height: 120px; opacity: 1; }

    .form-row { display: flex; gap: 10px; }
    .form-row button { flex: 1; }
    .btn-cancel { flex: 1; padding: 12px; background: transparent; color: #666; border: 1px solid #333; border-radius: 10px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 14px; }

    /* CARDS */
    .cards-list { display: flex; flex-direction: column; gap: 14px; }
    .card { border-radius: 16px; padding: 20px 24px; display: flex; align-items: flex-start; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; animation: fadeIn 0.3s ease; }
    .card:hover { transform: translateX(-4px); }
    .card-number { width: 32px; height: 32px; border-radius: 50%; font-size: 13px; font-weight: bold; display: flex; align-items: center; justify-content: center; margin-left: 18px; flex-shrink: 0; margin-top: 3px; }
    .card-info { flex: 1; }
    .card-subject { font-size: 18px; font-weight: bold; margin-bottom: 4px; }
    .card-pages { color: #aaa; font-size: 13px; }
    .card-pages span { color: #fff; font-weight: bold; }
    .card-questions { margin-top: 8px; padding: 8px 12px; background: rgba(100,210,255,0.08); border: 1px solid rgba(100,210,255,0.2); border-radius: 8px; font-size: 12px; color: #64d2ff; line-height: 1.5; }
    .card-questions-label { color: #3a8fa8; margin-left: 4px; }
    .card-hint { font-size: 11px; color: #444; margin-top: 6px; }
    .card-due { text-align: left; margin-left: 0; flex-shrink: 0; }
    .card-due.has-delete { margin-left: 16px; }
    .card-urgency { font-weight: bold; font-size: 13px; }
    .card-date { color: #555; font-size: 12px; margin-top: 3px; }
    .delete-btn { background: transparent; border: 1px solid #333; color: #555; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; line-height: 1; margin-top: 3px; }
    .delete-btn:hover { border-color: #ff2d55; color: #ff2d55; }

    /* EMPTY / FOOTER */
    .empty { text-align: center; padding: 80px 0; }
    .empty-emoji { font-size: 48px; margin-bottom: 16px; }
    .empty-text { color: #444; font-size: 16px; }
    .empty-sub { color: #333; font-size: 13px; margin-top: 8px; }
    .total-count { text-align: center; margin-top: 40px; color: #333; font-size: 12px; letter-spacing: 2px; }
    .credit { text-align: center; margin-top: 8px; color: #222; font-size: 11px; }

    /* MODALS */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.88); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(12px); z-index: 999; padding: 16px; }
    .modal { background: #111; border: 1px solid #333; border-radius: 20px; padding: 32px; width: 100%; max-width: 360px; }
    .modal-title { font-weight: bold; font-size: 18px; margin-bottom: 6px; }
    .modal-sub { color: #555; font-size: 13px; margin-bottom: 24px; }
    .modal-error { color: #ff2d55; font-size: 12px; margin-top: 6px; }
    .modal-link { color: #64d2ff; cursor: pointer; font-size: 12px; text-align: center; margin-top: 12px; }
    .modal-link:hover { text-decoration: underline; }

    /* ANSWERS MODAL */
    .answers-modal { background: #0f0f15; border: 1px solid #222; border-radius: 20px; width: 100%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
    .answers-header { padding: 20px 24px; border-bottom: 1px solid #1a1a1a; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .answers-title { font-size: 18px; font-weight: bold; }
    .answers-subject { font-size: 12px; color: #555; margin-top: 2px; }
    .close-btn { background: transparent; border: 1px solid #333; color: #666; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .close-btn:hover { border-color: #fff; color: #fff; }
    .answers-body { flex: 1; overflow-y: auto; padding: 20px 24px; }
    .answers-footer { padding: 16px 24px; border-top: 1px solid #1a1a1a; flex-shrink: 0; }

    /* UPLOAD AREA */
    .upload-area { border: 2px dashed #333; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 16px; }
    .upload-area:hover { border-color: #64d2ff; }
    .upload-area input { display: none; }
    .upload-area-text { color: #555; font-size: 13px; }
    .upload-area-text span { color: #64d2ff; }
    .upload-previews { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    .upload-preview { position: relative; width: 70px; height: 70px; border-radius: 8px; overflow: hidden; border: 1px solid #333; }
    .upload-preview img { width: 100%; height: 100%; object-fit: cover; }
    .upload-preview-remove { position: absolute; top: 2px; left: 2px; background: rgba(0,0,0,0.7); border: none; color: #fff; width: 18px; height: 18px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
    .upload-btn { width: 100%; padding: 12px; background: #64d2ff; color: #000; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 14px; font-family: 'Courier New', monospace; transition: background 0.2s; }
    .upload-btn:hover { background: #4ab8e8; }
    .upload-btn:disabled { background: #333; color: #666; cursor: not-allowed; }
    .uploading-text { text-align: center; color: #64d2ff; font-size: 13px; margin-top: 8px; }

    /* PHOTO GRID */
    .photos-grid { display: flex; flex-direction: column; gap: 16px; }
    .photo-card { background: #161620; border: 1px solid #222; border-radius: 14px; overflow: hidden; }
    .photo-card-header { padding: 10px 14px; display: flex; justify-content: space-between; align-items: center; }
    .photo-uploader { font-size: 13px; font-weight: bold; color: #fff; }
    .photo-time { font-size: 11px; color: #444; }
    .photo-img { width: 100%; max-height: 400px; object-fit: contain; background: #0a0a0f; cursor: pointer; }
    .photo-img:hover { opacity: 0.9; }
    .photo-actions { padding: 10px 14px; display: flex; align-items: center; gap: 10px; }
    .like-btn { background: transparent; border: 1px solid #333; border-radius: 8px; padding: 6px 14px; color: #888; cursor: pointer; font-size: 13px; font-family: 'Courier New', monospace; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
    .like-btn:hover { border-color: #ff2d55; color: #ff2d55; }
    .like-btn.liked { border-color: #ff2d55; color: #ff2d55; background: rgba(255,45,85,0.1); }
    .no-photos { text-align: center; padding: 40px 0; color: #333; font-size: 14px; }

    /* LIGHTBOX */
    .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; cursor: pointer; }
    .lightbox img { max-width: 95vw; max-height: 95vh; object-fit: contain; border-radius: 8px; }

    .hidden { display: none; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 500px) { header { padding: 16px; flex-wrap: wrap; gap: 10px; } .card { padding: 16px; } .card-subject { font-size: 15px; } .answers-modal { border-radius: 16px; } }
  </style>
</head>
<body>

<header>
  <div>
    <div class="header-title-label">×¤×•×¨×˜×œ ×›×™×ª×”</div>
    <div class="header-title">ğŸ“š ××¢×§×‘ ×©×™×¢×•×¨×™ ×‘×™×ª</div>
  </div>
  <div class="header-actions">
    <span class="user-badge hidden" id="userBadge"></span>
    <button class="btn btn-ghost hidden" id="logoutBtn" onclick="logout()">×™×¦×™××”</button>
    <button class="btn btn-white" id="adminBtn" onclick="toggleAdmin()">×›× ×™×¡×ª ×× ×”×œ</button>
  </div>
</header>

<main>
  <button class="add-btn-dashed hidden" id="addBtn" onclick="showAddForm()">+ ×”×•×¡×£ ×©×™×¢×•×¨×™ ×‘×™×ª</button>

  <div class="add-form hidden" id="addForm">
    <div class="form-title">××©×™××” ×—×“×©×”</div>
    <input type="text" id="subjectInput" placeholder="××§×¦×•×¢ (×œ××©×œ: ××ª××˜×™×§×”)" />
    <input type="text" id="pagesInput" placeholder="×¢××•×“×™× (×œ××©×œ: 45-67)" />
    <input type="date" id="dateInput" />
    <div class="checkbox-row" id="checkboxRow" onclick="toggleQuestions()">
      <div class="custom-checkbox" id="customCheckbox"></div>
      <span class="checkbox-label">×©××œ×•×ª ×¡×¤×¦×™×¤×™×•×ª ×‘×œ×‘×“</span>
    </div>
    <div class="questions-box" id="questionsBox">
      <textarea id="questionsInput" placeholder="×¨×©×•× ××™×œ×• ×©××œ×•×ª ×¦×¨×™×š ×œ×¢×©×•×ª (×œ××©×œ: 1, 3, 5-7, 12)"></textarea>
    </div>
    <div class="form-row">
      <button class="btn-full" style="flex:1;margin-top:0" onclick="addCard()">×”×•×¡×£</button>
      <button class="btn-cancel" onclick="hideAddForm()">×‘×™×˜×•×œ</button>
    </div>
  </div>

  <div class="cards-list" id="cardsList"></div>
  <div class="empty hidden" id="emptyState">
    <div class="empty-emoji">âœ¨</div>
    <div class="empty-text">××™×Ÿ ×©×™×¢×•×¨×™ ×‘×™×ª ×›×¨×’×¢.</div>
    <div class="empty-sub">×ª×”× ×• ××”×—×•×¤×©!</div>
  </div>
  <div class="total-count hidden" id="totalCount"></div>
  <div class="credit hidden" id="credit">×¨×•×Ÿ ×™××“×’×¨×•×‘</div>
</main>

<!-- AUTH MODAL -->
<div class="modal-overlay hidden" id="authModal">
  <div class="modal">
    <!-- Login -->
    <div id="loginView">
      <div class="modal-title">×›× ×™×¡×”</div>
      <div class="modal-sub">×”×›× ×¡ ××ª ×¤×¨×˜×™×š ×›×“×™ ×œ×”×¢×œ×•×ª ×ª×©×•×‘×•×ª</div>
      <input type="text" id="loginUser" placeholder="×©× ××©×ª××©" style="margin-bottom:10px" />
      <input type="password" id="loginPass" placeholder="×¡×™×¡××”" onkeydown="if(event.key==='Enter')doUserLogin()" />
      <div class="modal-error hidden" id="loginError"></div>
      <button class="btn-full" onclick="doUserLogin()">×›× ×™×¡×”</button>
      <div class="modal-link" onclick="switchToRegister()">××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×”×™×¨×©× ×›××Ÿ</div>
    </div>
    <!-- Register -->
    <div id="registerView" class="hidden">
      <div class="modal-title">×”×¨×©××”</div>
      <div class="modal-sub">×¦×•×¨ ×—×©×‘×•×Ÿ ×—×“×©</div>
      <input type="text" id="regUser" placeholder="×©× ××©×ª××©" style="margin-bottom:10px" />
      <input type="password" id="regPass" placeholder="×¡×™×¡××”" style="margin-bottom:10px" />
      <input type="password" id="regPass2" placeholder="××©×¨ ×¡×™×¡××”" onkeydown="if(event.key==='Enter')doRegister()" />
      <div class="modal-error hidden" id="registerError"></div>
      <button class="btn-full" onclick="doRegister()">×”×¨×©××”</button>
      <div class="modal-link" onclick="switchToLogin()">×›×‘×¨ ×™×© ×œ×š ×—×©×‘×•×Ÿ? ×›× ×¡ ×›××Ÿ</div>
    </div>
    <div style="text-align:center;margin-top:16px">
      <span style="color:#333;font-size:12px;cursor:pointer" onclick="closeAuthModal()">×‘×™×˜×•×œ</span>
    </div>
  </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div class="modal-overlay hidden" id="adminModal" onclick="closeAdminModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-title">×›× ×™×¡×ª ×× ×”×œ</div>
    <div class="modal-sub">×”×›× ×¡ ×¡×™×¡××” ×œ× ×™×”×•×œ ×©×™×¢×•×¨×™ ×”×‘×™×ª</div>
    <input type="password" id="adminPassInput" placeholder="×¡×™×¡××”" onkeydown="if(event.key==='Enter')doAdminLogin()" />
    <div class="modal-error hidden" id="adminPassError">×¡×™×¡××” ×©×’×•×™×”</div>
    <button class="btn-full" onclick="doAdminLogin()">×›× ×™×¡×”</button>
  </div>
</div>

<!-- ANSWERS MODAL -->
<div class="modal-overlay hidden" id="answersModal">
  <div class="answers-modal">
    <div class="answers-header">
      <div>
        <div class="answers-title">×ª×©×•×‘×•×ª</div>
        <div class="answers-subject" id="answersSubject"></div>
      </div>
      <button class="close-btn" onclick="closeAnswers()">&#215;</button>
    </div>

    <div class="answers-body" id="answersBody">
      <!-- Upload section -->
      <div id="uploadSection">
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
          <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFiles(event)" />
          <div class="upload-area-text">×œ×—×¥ ×›×“×™ ×œ×‘×—×•×¨ ×ª××•× ×•×ª<br><span>× ×™×ª×Ÿ ×œ×‘×—×•×¨ ××¡×¤×¨ ×ª××•× ×•×ª</span></div>
        </div>
        <div class="upload-previews" id="uploadPreviews"></div>
        <button class="upload-btn" id="uploadBtn" onclick="uploadPhotos()" disabled>×”×¢×œ×” ×ª×©×•×‘×•×ª</button>
        <div class="uploading-text hidden" id="uploadingText">××¢×œ×” ×ª××•× ×•×ª... ×× × ×”××ª×Ÿ</div>
      </div>

      <!-- Photos grid -->
      <div style="margin-top:24px">
        <div style="font-size:12px;color:#444;margin-bottom:12px;letter-spacing:1px">×ª×©×•×‘×•×ª ×©×”×•×¢×œ×•</div>
        <div class="photos-grid" id="photosGrid"></div>
        <div class="no-photos hidden" id="noPhotos">××™×Ÿ ×ª×©×•×‘×•×ª ×¢×“×™×™×Ÿ â€” ×”×™×” ×”×¨××©×•×Ÿ ×œ×”×¢×œ×•×ª!</div>
      </div>
    </div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox hidden" id="lightbox" onclick="closeLightbox()">
  <img id="lightboxImg" src="" />
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyB2TwGFKtyye9-QwIUnSXh2W4ggZ_AIIoE",
    authDomain: "hw-app-15b8f.firebaseapp.com",
    projectId: "hw-app-15b8f",
    storageBucket: "hw-app-15b8f.firebasestorage.app",
    messagingSenderId: "87867834430",
    appId: "1:87867834430:web:4a6c9ceb3e44cffa44116f"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const ADMIN_PASSWORD = "homework123";
  const IMGBB_KEY = "422246b6dc0e09efd2144d6017395f57";

  let isAdmin = false;
  let cards = [];
  let specificQuestions = false;
  let currentCardId = null;
  let currentUser = null;
  let pendingFiles = [];
  let photosUnsubscribe = null;

  // â”€â”€ SAVED LOGIN â”€â”€
  function loadSavedUser() {
    const saved = localStorage.getItem("hw_user");
    if (saved) {
      currentUser = JSON.parse(saved);
      updateUserUI();
    }
  }

  function updateUserUI() {
    const badge = document.getElementById("userBadge");
    const logoutBtn = document.getElementById("logoutBtn");
    if (currentUser) {
      badge.textContent = "×©×œ×•×, " + currentUser.username;
      badge.classList.remove("hidden");
      logoutBtn.classList.remove("hidden");
    } else {
      badge.classList.add("hidden");
      logoutBtn.classList.add("hidden");
    }
  }

  function logout() {
    currentUser = null;
    localStorage.removeItem("hw_user");
    updateUserUI();
  }

  // â”€â”€ REGISTRATION / LOGIN â”€â”€
  function openAuthModal() {
    document.getElementById("authModal").classList.remove("hidden");
    switchToLogin();
  }

  function closeAuthModal() {
    document.getElementById("authModal").classList.add("hidden");
  }

  function switchToRegister() {
    document.getElementById("loginView").classList.add("hidden");
    document.getElementById("registerView").classList.remove("hidden");
  }

  function switchToLogin() {
    document.getElementById("registerView").classList.add("hidden");
    document.getElementById("loginView").classList.remove("hidden");
    document.getElementById("loginError").classList.add("hidden");
  }

  async function doRegister() {
    const username = document.getElementById("regUser").value.trim();
    const pass = document.getElementById("regPass").value;
    const pass2 = document.getElementById("regPass2").value;
    const errEl = document.getElementById("registerError");

    if (!username || !pass) { showErr(errEl, "× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª"); return; }
    if (pass !== pass2) { showErr(errEl, "×”×¡×™×¡×××•×ª ××™× ×Ÿ ×ª×•×××•×ª"); return; }
    if (username.length < 2) { showErr(errEl, "×©× ××©×ª××© ×§×¦×¨ ××“×™"); return; }
    if (pass.length < 4) { showErr(errEl, "×¡×™×¡××” ×§×¦×¨×” ××“×™ (×œ×¤×—×•×ª 4 ×ª×•×•×™×)"); return; }

    // Check if username taken
    const existing = await db.collection("users").doc(username).get();
    if (existing.exists) { showErr(errEl, "×©× ××©×ª××© ×›×‘×¨ ×ª×¤×•×¡"); return; }

    await db.collection("users").doc(username).set({ username, password: pass });
    currentUser = { username };
    localStorage.setItem("hw_user", JSON.stringify(currentUser));
    updateUserUI();
    closeAuthModal();
    // Re-open answers if was pending
    if (currentCardId) openAnswers(currentCardId);
  }

  async function doUserLogin() {
    const username = document.getElementById("loginUser").value.trim();
    const pass = document.getElementById("loginPass").value;
    const errEl = document.getElementById("loginError");

    if (!username || !pass) { showErr(errEl, "× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª"); return; }

    const doc = await db.collection("users").doc(username).get();
    if (!doc.exists || doc.data().password !== pass) {
      showErr(errEl, "×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×");
      return;
    }

    currentUser = { username };
    localStorage.setItem("hw_user", JSON.stringify(currentUser));
    updateUserUI();
    closeAuthModal();
    if (currentCardId) openAnswers(currentCardId);
  }

  function showErr(el, msg) {
    el.textContent = msg;
    el.classList.remove("hidden");
  }

  // â”€â”€ ADMIN â”€â”€
  function toggleAdmin() {
    if (isAdmin) {
      isAdmin = false;
      document.getElementById("adminBtn").textContent = "×›× ×™×¡×ª ×× ×”×œ";
      document.getElementById("adminBtn").className = "btn btn-white";
      document.getElementById("addBtn").classList.add("hidden");
      hideAddForm(); render();
    } else {
      document.getElementById("adminModal").classList.remove("hidden");
      setTimeout(() => document.getElementById("adminPassInput").focus(), 100);
    }
  }

  function doAdminLogin() {
    const pass = document.getElementById("adminPassInput").value;
    if (pass === ADMIN_PASSWORD) {
      isAdmin = true;
      document.getElementById("adminModal").classList.add("hidden");
      document.getElementById("adminPassInput").value = "";
      document.getElementById("adminPassError").classList.add("hidden");
      document.getElementById("adminBtn").textContent = "×™×¦×™××ª ×× ×”×œ";
      document.getElementById("adminBtn").className = "btn btn-danger";
      document.getElementById("addBtn").classList.remove("hidden");
      render();
    } else {
      document.getElementById("adminPassError").classList.remove("hidden");
    }
  }

  function closeAdminModal(e) {
    document.getElementById("adminModal").classList.add("hidden");
    document.getElementById("adminPassInput").value = "";
    document.getElementById("adminPassError").classList.add("hidden");
  }

  // â”€â”€ HOMEWORK FORM â”€â”€
  function toggleQuestions() {
    specificQuestions = !specificQuestions;
    document.getElementById("customCheckbox").classList.toggle("checked", specificQuestions);
    document.getElementById("checkboxRow").classList.toggle("active", specificQuestions);
    document.getElementById("questionsBox").classList.toggle("open", specificQuestions);
    if (specificQuestions) setTimeout(() => document.getElementById("questionsInput").focus(), 300);
    else document.getElementById("questionsInput").value = "";
  }

  function showAddForm() {
    document.getElementById("addForm").classList.remove("hidden");
    document.getElementById("addBtn").classList.add("hidden");
  }

  function hideAddForm() {
    document.getElementById("addForm").classList.add("hidden");
    if (isAdmin) document.getElementById("addBtn").classList.remove("hidden");
  }

  async function addCard() {
    const subject = document.getElementById("subjectInput").value.trim();
    const pages = document.getElementById("pagesInput").value.trim();
    const dueDate = document.getElementById("dateInput").value;
    const questions = specificQuestions ? document.getElementById("questionsInput").value.trim() : "";
    if (!subject || !pages || !dueDate) return alert("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª!");
    if (specificQuestions && !questions) return alert("× × ×œ×¨×©×•× ××ª ×”×©××œ×•×ª ×”×¡×¤×¦×™×¤×™×•×ª!");
    await db.collection("homework").add({ subject, pages, dueDate, questions });
    document.getElementById("subjectInput").value = "";
    document.getElementById("pagesInput").value = "";
    document.getElementById("dateInput").value = "";
    document.getElementById("questionsInput").value = "";
    if (specificQuestions) toggleQuestions();
    hideAddForm();
  }

  async function deleteCard(id) {
    if (confirm("×œ××—×•×§ ××©×™××” ×–×•?")) {
      await db.collection("homework").doc(id).delete();
    }
  }

  // â”€â”€ RENDER CARDS â”€â”€
  function getDaysUntil(dateStr) {
    const today = new Date(); today.setHours(0,0,0,0);
    const due = new Date(dateStr); due.setHours(0,0,0,0);
    return Math.round((due - today) / 86400000);
  }

  function getUrgency(days) {
    if (days < 0)   return { label: "×¤×’ ×ª×•×§×£!",          color: "#ff2d55", bg: "#2a0a10", border: "#ff2d55", glow: "0 0 20px #ff2d5566" };
    if (days === 0) return { label: "×œ×”×’×©×” ×”×™×•×!",        color: "#ff6b35", bg: "#2a1200", border: "#ff6b35", glow: "0 0 20px #ff6b3566" };
    if (days === 1) return { label: "×œ×”×’×©×” ××—×¨",          color: "#ffcc02", bg: "#2a2000", border: "#ffcc02", glow: "0 0 20px #ffcc0244" };
    if (days <= 3)  return { label: "×¢×•×“ "+days+" ×™××™×",  color: "#ff9f0a", bg: "#201500", border: "#ff9f0a", glow: "0 0 15px #ff9f0a33" };
    if (days <= 7)  return { label: "×¢×•×“ "+days+" ×™××™×",  color: "#30d158", bg: "#0a1f10", border: "#30d158", glow: "0 0 15px #30d15833" };
    return           { label: "×¢×•×“ "+days+" ×™××™×",        color: "#64d2ff", bg: "#001a2a", border: "#64d2ff44", glow: "none" };
  }

  function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString("he-IL", { weekday: "short", month: "short", day: "numeric" });
  }

  function render() {
    const list = document.getElementById("cardsList");
    const empty = document.getElementById("emptyState");
    const total = document.getElementById("totalCount");
    const credit = document.getElementById("credit");
    list.innerHTML = "";
    const sorted = [...cards].sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
    if (sorted.length === 0) {
      empty.classList.remove("hidden");
      total.classList.add("hidden");
      credit.classList.add("hidden");
    } else {
      empty.classList.add("hidden");
      total.classList.remove("hidden");
      credit.classList.remove("hidden");
      total.textContent = "×¡×”\"×› " + sorted.length + " ××©×™××•×ª";
      sorted.forEach((card, i) => {
        const days = getDaysUntil(card.dueDate);
        const u = getUrgency(days);
        const div = document.createElement("div");
        div.className = "card";
        div.style.cssText = `background:${u.bg};border:1px solid ${u.border};box-shadow:${u.glow}`;
        div.onclick = (e) => {
          if (e.target.classList.contains("delete-btn") || e.target.closest(".delete-btn")) return;
          handleCardClick(card.id);
        };
        const questionsHTML = card.questions
          ? `<div class="card-questions"><span class="card-questions-label">×©××œ×•×ª:</span>${card.questions}</div>`
          : "";
        div.innerHTML = `
          <div class="card-number" style="border:1px solid ${u.color}44;color:${u.color}">#${i+1}</div>
          <div class="card-info">
            <div class="card-subject">${card.subject}</div>
            <div class="card-pages">×¢××•×“×™× <span>${card.pages}</span></div>
            ${questionsHTML}
            <div class="card-hint">×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×ª×©×•×‘×•×ª âœ¦</div>
          </div>
          <div class="card-due ${isAdmin ? 'has-delete' : ''}">
            <div class="card-urgency" style="color:${u.color}">${u.label}</div>
            <div class="card-date">${formatDate(card.dueDate)}</div>
          </div>
          ${isAdmin ? `<button class="delete-btn" onclick="deleteCard('${card.id}')">&#215;</button>` : ""}
        `;
        list.appendChild(div);
      });
    }
  }

  let prevCount = null;
  db.collection("homework").orderBy("dueDate").onSnapshot(snapshot => {
    cards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    prevCount = cards.length;
    render();
  });

  // â”€â”€ ANSWERS MODAL â”€â”€
  function handleCardClick(cardId) {
    if (!currentUser) {
      currentCardId = cardId;
      openAuthModal();
      return;
    }
    openAnswers(cardId);
  }

  function openAnswers(cardId) {
    currentCardId = cardId;
    const card = cards.find(c => c.id === cardId);
    document.getElementById("answersSubject").textContent = card ? card.subject + " â€” ×¢×' " + card.pages : "";
    document.getElementById("answersModal").classList.remove("hidden");
    pendingFiles = [];
    renderPreviews();
    document.getElementById("uploadBtn").disabled = true;
    document.getElementById("uploadingText").classList.add("hidden");
    loadPhotos(cardId);
  }

  function closeAnswers() {
    document.getElementById("answersModal").classList.add("hidden");
    if (photosUnsubscribe) { photosUnsubscribe(); photosUnsubscribe = null; }
    currentCardId = null;
    document.getElementById("fileInput").value = "";
    pendingFiles = [];
    renderPreviews();
  }

  function loadPhotos(cardId) {
    if (photosUnsubscribe) photosUnsubscribe();
    const grid = document.getElementById("photosGrid");
    const noPhotos = document.getElementById("noPhotos");
    grid.innerHTML = '<div style="text-align:center;color:#444;font-size:13px;padding:20px">×˜×•×¢×Ÿ...</div>';
    noPhotos.classList.add("hidden");

    photosUnsubscribe = db.collection("homework").doc(cardId).collection("photos")
      .orderBy("timestamp", "desc")
      .onSnapshot(snapshot => {
        const photos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        grid.innerHTML = "";
        if (photos.length === 0) {
          noPhotos.classList.remove("hidden");
        } else {
          noPhotos.classList.add("hidden");
          photos.forEach(photo => {
            const liked = currentUser && photo.likes && photo.likes.includes(currentUser.username);
            const likeCount = photo.likes ? photo.likes.length : 0;
            const time = photo.timestamp ? new Date(photo.timestamp.toDate()).toLocaleDateString("he-IL", { day:"numeric", month:"short", hour:"2-digit", minute:"2-digit" }) : "";
            const div = document.createElement("div");
            div.className = "photo-card";
            div.innerHTML = `
              <div class="photo-card-header">
                <span class="photo-uploader">ğŸ‘¤ ${photo.uploader}</span>
                <span class="photo-time">${time}</span>
              </div>
              <img class="photo-img" src="${photo.url}" loading="lazy" onclick="openLightbox('${photo.url}')" />
              <div class="photo-actions">
                <button class="like-btn ${liked ? 'liked' : ''}" onclick="toggleLike('${photo.id}')">
                  â¤ï¸ ${likeCount > 0 ? likeCount : "×œ×™×™×§"}
                </button>
              </div>
            `;
            grid.appendChild(div);
          });
        }
      });
  }

  async function toggleLike(photoId) {
    if (!currentUser) return;
    const ref = db.collection("homework").doc(currentCardId).collection("photos").doc(photoId);
    const doc = await ref.get();
    if (!doc.exists) return;
    const likes = doc.data().likes || [];
    const username = currentUser.username;
    if (likes.includes(username)) {
      await ref.update({ likes: likes.filter(u => u !== username) });
    } else {
      await ref.update({ likes: [...likes, username] });
    }
  }

  // â”€â”€ PHOTO UPLOAD â”€â”€
  function handleFiles(e) {
    const files = Array.from(e.target.files);
    pendingFiles = [...pendingFiles, ...files];
    renderPreviews();
    document.getElementById("uploadBtn").disabled = pendingFiles.length === 0;
  }

  function renderPreviews() {
    const container = document.getElementById("uploadPreviews");
    container.innerHTML = "";
    pendingFiles.forEach((file, i) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const wrap = document.createElement("div");
        wrap.className = "upload-preview";
        wrap.innerHTML = `
          <img src="${e.target.result}" />
          <button class="upload-preview-remove" onclick="removeFile(${i})">&#215;</button>
        `;
        container.appendChild(wrap);
      };
      reader.readAsDataURL(file);
    });
  }

  function removeFile(index) {
    pendingFiles.splice(index, 1);
    renderPreviews();
    document.getElementById("uploadBtn").disabled = pendingFiles.length === 0;
  }

  async function uploadToImgBB(file) {
    const formData = new FormData();
    formData.append("image", file);
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: formData });
    const data = await res.json();
    if (!data.success) throw new Error("×©×’×™××” ×‘×”×¢×œ××”");
    return data.data.url;
  }

  async function uploadPhotos() {
    if (!currentUser || pendingFiles.length === 0) return;
    const btn = document.getElementById("uploadBtn");
    const uploadingText = document.getElementById("uploadingText");
    btn.disabled = true;
    uploadingText.classList.remove("hidden");

    try {
      for (const file of pendingFiles) {
        const url = await uploadToImgBB(file);
        await db.collection("homework").doc(currentCardId).collection("photos").add({
          url,
          uploader: currentUser.username,
          likes: [],
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      pendingFiles = [];
      renderPreviews();
      document.getElementById("fileInput").value = "";
    } catch (err) {
      alert("×©×’×™××” ×‘×”×¢×œ××ª ×ª××•× ×•×ª: " + err.message);
    }

    btn.disabled = true;
    uploadingText.classList.add("hidden");
  }

  // â”€â”€ LIGHTBOX â”€â”€
  function openLightbox(url) {
    document.getElementById("lightboxImg").src = url;
    document.getElementById("lightbox").classList.remove("hidden");
  }

  function closeLightbox() {
    document.getElementById("lightbox").classList.add("hidden");
    document.getElementById("lightboxImg").src = "";
  }

  // â”€â”€ INIT â”€â”€
  loadSavedUser();
</script>
</body>
</html>
